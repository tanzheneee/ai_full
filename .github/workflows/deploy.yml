name: CI/CD Deployment

on:
  push:
    branches:
      - master # 仅在代码推送到 main 分支时触发

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 1. 登录 Docker Hub
      # ----------------------------------------------------
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ----------------------------------------------------
      # 2. 构建并推送镜像
      # ----------------------------------------------------
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ai_full_app:latest # 您的 Docker Hub 仓库名称

      # ----------------------------------------------------
      # 3. SSH 远程部署 (CD)
      # ----------------------------------------------------
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            # 1. 进入您的项目目录
            cd /home/ubuntu/work_space/ai_full/
            
            # 2. 拉取最新的镜像 (仅拉取 ai_full_app)
            # 注意：此处使用 docker pull 拉取，然后 docker-compose up 会使用它
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/ai_full_app:latest
            
            # 3. 使用 docker-compose 重新部署服务
            # ⚠️ 确保您的 docker-compose.yml 文件中使用的是镜像名，而不是 build: .
            # 需修改 docker-compose.yml 中的 ai_full_app 定义
            sudo docker-compose up -d --force-recreate ai_full_app